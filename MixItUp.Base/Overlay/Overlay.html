<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Mix It Up - Overlay</title>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script src="jquery-3.6.0.min.js"></script>
    <script src="webSocketWrapper.js"></script>

    <script src="https://code.responsivevoice.org/responsivevoice.js?key=PkwySfvE"></script>
</head>
<body style="background-color: transparent; overflow: hidden; position: absolute; width: 100%; max-width: 100%; min-width: 100%; height: 100%; max-height: 100%; min-height: 100%; margin: 0px;">

    <div id="mainOverlay" style="position: absolute; width: 100%; max-width: 100%; min-width: 100%; height: 100%; max-height: 100%; min-height: 100%; margin: 0px;"></div>

    <p id="connectionTest" style="visibility: hidden; font-size: 100px; color: red; white-space: nowrap; position: absolute; margin: 0px; left: 50%; top: 50%; transform: translate(-50%, -50%);">Connection Test!</p>

    <div id="noTextToSpeechDiv" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); visibility: hidden">
        <h1 style="font-size: 100px; color: red; text-align: center">This Browser Does</h1>
        <h1 style="font-size: 100px; color: red; text-align: center">Not Support</h1>
        <h1 style="font-size: 100px; color: red; text-align: center">Text To Speech!</h1>
    </div>

    <script>
        var mainOverlayDiv = document.getElementById('mainOverlay');
        var noTextToSpeechDiv = document.getElementById('noTextToSpeechDiv');
        var youtubeIFrameAPIReady = false;

        var iframes = new Map();

        function packetReceived(packet) {
            try {
                if (packet != null && typeof packet.Type !== 'undefined') {
                    if (typeof packet.Data !== 'undefined' && packet.Data.length > 0) {
                        if (packet.Type === 'Add') {
                            for (var i = 0; i < packet.Data.length; i++) {
                                processAdd(packet.Data[i]);
                            }
                        }
                        else if (packet.Type === 'Remove') {
                            for (var i = 0; i < packet.Data.length; i++) {
                                processRemove(packet.Data[i]);
                            }
                        }
                        else if (packet.Type === 'Basic') {
                            for (var i = 0; i < packet.Data.length; i++) {
                                processBasic(packet.Data[i]);
                            }
                        }
                        else if (packet.Type === 'YouTube') {
                            processYouTube(packet.Data[0]);
                        }
                        else if (packet.Type === 'TextToSpeech') {
                            processTextToSpeech(packet.Data[0]);
                        }
                    }
                    else if (packet.Type == 'Test') {
                        var connectionTest = document.getElementById("connectionTest");
                        connectionTest.style.visibility = 'visible';
                        setTimeout(function () {
                            connectionTest.style.visibility = 'hidden';
                        }, 3000);
                    }
                }
            }
            catch (err) { logException(err); }
        }

        function processAdd(data) {
            if (!iframes.has(data.ID)) {
                var iframeContainer = createIFrameContainer(data.URL);

                mainOverlayDiv.appendChild(iframeContainer);

                iframes.set(data.ID, iframeContainer);
            }
        }

        function processRemove(data) {
            if (!iframes.has(data.ID)) {
                mainOverlayDiv.removeChild(widgetData.get(data.ID));

                widgetData.delete(data.ID);
            }
        }

        function processBasic(data) {
            var duration = parseFloat(data.Duration);
            if (duration != NaN) {

                if (duration <= 0) {
                    duration = 0;
                }

                var iframeContainer = createIFrameContainer(data.URL);
                iframeContainer.firstChild.onload = function () {
                    setTimeout(function () {
                        mainOverlayDiv.removeChild(iframeContainer);
                    }, duration * 1000);
                }

                mainOverlayDiv.appendChild(iframeContainer);
            }
        }

        function processYouTube(data) {

        }

        function processTextToSpeech(data) {
            responsiveVoice.forcedFallbackMode = true;
            if (responsiveVoice.voiceSupport()) {
                responsiveVoice.speak(data.Text, data.Voice, { pitch: data.Pitch, rate: data.Rate, volume: data.Volume });
            }
        }

        function createIFrameContainer(url) {
            var div = document.createElement("div");
            div.style = "display: block; position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; margin: 0; padding: 0";

            var iframe = document.createElement("iframe");
            iframe.style = "position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; margin: 0; padding: 0; border: none;";
            iframe.sandbox = "allow-scripts allow-same-origin";
            iframe.src = url;

            div.appendChild(iframe);

            return div;
        }

        function logException(err) {
            console.error(err);
            logToSessionStorage(err);
        }

        function onYouTubeIframeAPIReady() {
            youtubeIFrameAPIReady = true;
        }

        openWebsocketConnection("/overlay/ws/");
    </script>
</body>
</html>

<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Mix It Up - Overlay</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://github.com/SaviorXTanren/mixer-mixitup/raw/master/Branding/MixItUp-Logo-Base-WhiteXS.png" />

    <script src="jquery-3.6.0.min.js"></script>
    <script src="webSocketWrapper.js"></script>

    <!--<link rel="stylesheet" href="bootstrap.min.css">
    <script src="bootstrap.min.js"></script>-->

    <!--<link href="video-js.css" rel="stylesheet">-->
    <script src="video.min.js"></script>

    <link rel="stylesheet" type="text/css" href="animate.min.css">

    <script src="https://code.responsivevoice.org/responsivevoice.js?key=PkwySfvE"></script>
</head>
<body style="background-color: transparent; overflow: hidden; position: absolute; width: 100%; max-width: 100%; min-width: 100%; height: 100%; max-height: 100%; min-height: 100%; margin: 0px;">

    <div id="mainOverlay" style="position: absolute; width: 100%; max-width: 100%; min-width: 100%; height: 100%; max-height: 100%; min-height: 100%; margin: 0px;"></div>

    <div id="noConnectionDiv" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); visibility: hidden">
        <h1 style="font-size: 100px; color: red; text-align: center">No Connection To</h1>
        <h1 style="font-size: 100px; color: red; text-align: center">Mix It Up Overlay!</h1>
    </div>

    <div id="noTextToSpeechDiv" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); visibility: hidden">
        <h1 style="font-size: 100px; color: red; text-align: center">This Browser Does</h1>
        <h1 style="font-size: 100px; color: red; text-align: center">Not Support</h1>
        <h1 style="font-size: 100px; color: red; text-align: center">Text To Speech!</h1>
    </div>

    <script>
        var mainOverlayDiv = document.getElementById('mainOverlay');
        var noConnectionDiv = document.getElementById('noConnectionDiv');
        var noTextToSpeechDiv = document.getElementById('noTextToSpeechDiv');

        var widgets = new Map();

        // YouTube player
        var youtubeIFrameAPIReady = false;
        var youtubeVideoPlayer;

        var youtubePlayerScript = document.createElement('script');
        youtubePlayerScript.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(youtubePlayerScript, firstScriptTag);

        const animateCSS = (element, animation, prefix = 'animate__') =>
            // We create a Promise and return it
            new Promise((resolve, reject) => {
                if (animation != null && animation) {
                    const animationName = `${prefix}${animation}`;

                    element.classList.add(`${prefix}animated`, animationName);

                    // When the animation ends, we clean the classes and resolve the Promise
                    function handleAnimationEnd(event) {
                        event.stopPropagation();
                        element.classList.remove(`${prefix}animated`, animationName);
                        resolve('Animation ended');
                    }

                    element.addEventListener('animationend', handleAnimationEnd, { once: true });
                }
                else {
                    resolve('Animation ended');
                }
            });

        function connectionOpened() {
            noConnectionDiv.style.visibility = 'hidden';
        }

        function connectionClosed() {
            noConnectionDiv.style.visibility = 'visible';
        }

        function packetReceived(packet) {
            try {
                if (packet != null && typeof packet.type !== 'undefined') {
                    var data = packet.data;
                    if (packet.type === 'Basic') {
                        processBasic(data);
                    }
                    else if (packet.type === 'YouTube') {
                        if (youtubeIFrameAPIReady) {
                            processBasic(data);

                            var videoID = data.VideoID;
                            videoID = videoID.replace("https://www.youtube.com/watch?v=", "");
                            videoID = videoID.replace("https://youtu.be/", "");
                            if (videoID.includes("&")) {
                                videoID = videoID.substring(0, videoID.indexOf("&"));
                            }

                            var youtubeVideoPlayer = new YT.Player(data.ID, {
                                height: data.Height,
                                width: data.Width,
                                videoId: videoID,
                                playerVars: { 'controls': 0, 'modestbranding': 1, 'start': data.StartTime },
                                events: {
                                    'onReady': function () {
                                        youtubeVideoPlayer.setVolume(data.Volume);
                                        youtubeVideoPlayer.setLoop(false);
                                        youtubeVideoPlayer.frameBorder = 0;
                                        youtubeVideoPlayer.playVideo();
                                    },
                                    'onStateChange': function (event) {
                                        if (event.data == YT.PlayerState.ENDED) {
                                            event.target.destroy();
                                        }
                                    }
                                }
                            });
                        }
                    }
                    else if (packet.type === 'Enable') {
                        if (!widgets.has(data.ID)) {
                            widgets.set(data.ID, addItem(data));
                        }
                    }
                    else if (packet.type === 'Update') {
                        if (widgets.has(data.ID)) {
                            removeItem(widgets.get(data.ID));
                            widgets.delete(data.ID);
                        }
                        widgets.set(data.ID, addItem(data));
                    }
                    else if (packet.type === 'Disable') {
                        if (widgets.has(data.ID)) {
                            removeItem(widgets.get(data.ID));
                            widgets.delete(data.ID);
                        }
                    }
                    else if (packet.type === 'TimerAdjustTime') {
                        window[data.ID + "_adjustTime"](data.Time);
                    }
                    else if (packet.type === 'LabelUpdate') {
                        window[data.ID + "_update"](data.Username, data.Amount);
                    }
                    else if (packet.type === 'EventListAdd') {
                        window[data.ID + "_add"](data.EventType, data.Details, data.SubDetails);
                    }
                    else if (packet.type === 'GoalUpdate') {
                        window[data.ID + "_update"](data.CurrentAmount, data.GoalAmount, data.Width);
                    }
                }
            }
            catch (err) { logException(err); }
        }

        function processBasic(data) {
            var duration = parseFloat(data.Duration);
            if (duration != NaN) {

                if (duration <= 0) {
                    duration = 0;
                }

                var item = addItem(data);

                try {
                    window[data.ID + "_load"]();
                } catch (error) { }

                animateCSS(item.HTML, data.EntranceAnimation.AnimateCSSAnimationName).then((message) => {

                    setTimeout(function () {

                        animateCSS(item.HTML, data.VisibleAnimation.AnimateCSSAnimationName).then((message) => { });

                        setTimeout(function () {

                            animateCSS(item.HTML, data.ExitAnimation.AnimateCSSAnimationName).then((message) => {

                                removeItem(item);
                            });

                        }, (duration * 1000) / 2);

                    }, (duration * 1000) / 2);

                });
            }
        }

        function addItem(data) {
            var item = {};

            item.Script = addJavascript(data.Javascript);
            item.Style = addCSS(data.CSS);
            item.HTML = addHTML(data.HTML);

            return item;
        }

        function addHTML(html) {
            var addedElement = document.createElement('div');
            addedElement.innerHTML = html;
            addedElement = addedElement.firstChild;

            mainOverlayDiv.appendChild(addedElement);

            return addedElement;
        }

        function addCSS(css) {
            if (css != null && css) {
                var style = document.createElement('style');
                style.setAttribute('type', 'text/css');

                if (style.styleSheet) {   // IE
                    style.styleSheet.cssText = css;
                } else {                // the world
                    style.appendChild(document.createTextNode(css));
                }

                document.head.appendChild(style);

                return style;
            }
            return null;
        }

        function addJavascript(javascript) {
            if (javascript != null && javascript) {
                var script = document.createElement('script');
                script.setAttribute('type', 'text/javascript');

                script.text = javascript;

                document.body.appendChild(script);

                return script;
            }
            return null;
        }

        function removeItem(item) {
            if (item.HTML != null) {
                mainOverlayDiv.removeChild(item.HTML);
            }

            if (item.Style != null) {
                document.head.removeChild(item.Style);
            }

            if (item.Script != null) {
                document.body.removeChild(item.Script);
            }
        }

        function logException(err) {
            console.error(err);
            logToSessionStorage(err);
        }

        function onYouTubeIframeAPIReady() {
            youtubeIFrameAPIReady = true;
        }

        openWebsocketConnection();
    </script>
</body>
</html>

<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Mix It Up - Overlay</title>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script src="jquery-3.6.0.min.js"></script>
    <script src="webSocketWrapper.js"></script>

    <script src="https://code.responsivevoice.org/responsivevoice.js?key=PkwySfvE"></script>
</head>
<body style="background-color: transparent; overflow: hidden; position: absolute; width: 100%; max-width: 100%; min-width: 100%; height: 100%; max-height: 100%; min-height: 100%; margin: 0px;">

    <div id="mainOverlay" style="position: absolute; width: 100%; max-width: 100%; min-width: 100%; height: 100%; max-height: 100%; min-height: 100%; margin: 0px;"></div>

    <p id="connectionTest" style="visibility: hidden; font-size: 100px; color: red; white-space: nowrap; position: absolute; margin: 0px; left: 50%; top: 50%; transform: translate(-50%, -50%);">Connection Test!</p>

    <script>
        var mainOverlayDiv = document.getElementById('mainOverlay');
        var noTextToSpeechDiv = document.getElementById('noTextToSpeechDiv');
        var youtubeIFrameAPIReady = false;

        var iframes = new Map();

        function packetReceived(packet) {
            try {
                if (packet != null) {
                    if (Array.isArray(packet)) {
                        for (var i = 0; i < packet.length; i++) {
                            processPacket(packet[i]);
                        }
                    }
                    else {
                        processPacket(packet);
                    }
                }
            }
            catch (err) { logException(err); }
        }

        function processPacket(packet) {
            if (typeof packet.Type !== 'undefined' && packet.Type != null) {
                if (packet.Type === 'Add') {
                    processAdd(packet.Data);
                }
                else if (packet.Type === 'Update') {
                    processUpdate(packet.Data);
                }
                else if (packet.Type === 'Remove') {
                    processRemove(packet.Data);
                }
                else if (packet.Type === 'Basic') {
                    processBasic(packet.Data);
                }
                else if (packet.Type === 'ResponsiveVoice') {
                    processResponsiveVoice(packet.Data);
                }
                else if (packet.Type == 'Test') {
                    var connectionTest = document.getElementById("connectionTest");
                    connectionTest.style.visibility = 'visible';
                    setTimeout(function () {
                        connectionTest.style.visibility = 'hidden';
                    }, 3000);
                }
            }
        }

        function processAdd(data) {
            if (!iframes.has(data.ID)) {
                var iframeContainer = createIFrameContainer(data.URL);

                mainOverlayDiv.appendChild(iframeContainer);

                iframes.set(data.ID, iframeContainer);
            }
        }

        function processUpdate(data) {
            if (iframes.has(data.ID)) {
                var iframeContainer = iframes.get(data.ID);

                callIFrameFunction(iframeContainer, data.FunctionName, data);
            }
        }

        function processRemove(data) {
            if (iframes.has(data.ID)) {
                mainOverlayDiv.removeChild(iframes.get(data.ID));

                iframes.delete(data.ID);
            }
        }

        function processBasic(data) {
            var iframeContainer = createIFrameContainer(data.URL);

            mainOverlayDiv.appendChild(iframeContainer);

            iframes.set(data.ID, iframeContainer);
        }

        function processResponsiveVoice(data) {
            responsiveVoice.forcedFallbackMode = true;
            if (responsiveVoice.voiceSupport()) {
                responsiveVoice.speak(data.Text, data.Voice, { volume: data.Volume, pitch: data.Pitch, rate: data.Rate, onend: function () {
                    sendPacket("ResponseVoiceTextToSpeechComplete", [data.ID]);
                }});
            }
        }

        function createIFrameContainer(url) {
            var div = document.createElement("div");
            div.style = "display: block; position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; margin: 0; padding: 0";

            var iframe = document.createElement("iframe");
            iframe.style = "position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; margin: 0; padding: 0; border: none;";
            iframe.sandbox = "allow-scripts allow-same-origin";
            iframe.src = url;

            div.appendChild(iframe);

            return div;
        }

        function callIFrameFunction(iframeContainer, functionName, obj) {
            iframeContainer.firstChild.contentWindow[functionName](obj);
        }

        function sendIFrameMessage(iframe, obj) {
            iframe.contentWindow.postMessage(JSON.stringify(obj), '*');
        }

        function logException(err) {
            console.error(err);
            logToSessionStorage(err);
        }

        function onYouTubeIframeAPIReady() {
            youtubeIFrameAPIReady = true;
        }

        openWebsocketConnection("/overlay/ws/");

        window.onmessage = function (message) {
            if (message != null && message.data != null && message.data.length > 0) {
                var obj = JSON.parse(message.data);
                if (typeof obj.Type !== 'undefined' && typeof obj.ID !== 'undefined') {
                    if (obj.Type == 'Remove' && iframes.has(obj.ID)) {
                        mainOverlayDiv.removeChild(iframes.get(obj.ID));
                    }
                }
            }
        };
    </script>
</body>
</html>

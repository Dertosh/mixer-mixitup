<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Mix It Up - Overlay</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://github.com/SaviorXTanren/mixer-mixitup/raw/master/Branding/MixItUp-Logo-Base-WhiteXS.png" />

    <script src="jquery-3.6.0.min.js"></script>
    <script src="webSocketWrapper.js"></script>

    <script src="https://code.responsivevoice.org/responsivevoice.js?key=PkwySfvE"></script>
</head>
<body style="background-color: transparent; overflow: hidden; position: absolute; width: 100%; max-width: 100%; min-width: 100%; height: 100%; max-height: 100%; min-height: 100%; margin: 0px;">

    <template id="iframeContainer">
        <div style="display: block; position: absolute; top: 0px; left: 0px">
            <iframe class="iframeContainer" frameborder="0" allowtransparency="yes" scrolling="no" style="border: none; width: 100%; height: 100%; position: absolute; top: 0px; left: 0px; margin: 0; padding: 0;" />
        </div>
    </template>

    <div id="mainOverlay" style="position: absolute; width: 100%; max-width: 100%; min-width: 100%; height: 100%; max-height: 100%; min-height: 100%; margin: 0px;"></div>

    <div id="noConnectionDiv" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); visibility: hidden">
        <h1 style="font-size: 100px; color: red; text-align: center">No Connection To</h1>
        <h1 style="font-size: 100px; color: red; text-align: center">Mix It Up Overlay!</h1>
    </div>

    <div id="noTextToSpeechDiv" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); visibility: hidden">
        <h1 style="font-size: 100px; color: red; text-align: center">This Browser Does</h1>
        <h1 style="font-size: 100px; color: red; text-align: center">Not Support</h1>
        <h1 style="font-size: 100px; color: red; text-align: center">Text To Speech!</h1>
    </div>

    <script>
        var mainOverlayDiv = document.getElementById('mainOverlay');
        var noConnectionDiv = document.getElementById('noConnectionDiv');
        var noTextToSpeechDiv = document.getElementById('noTextToSpeechDiv');

        var iframes = new Map();

        function connectionOpened() {
            noConnectionDiv.style.visibility = 'hidden';
        }

        function connectionClosed() {
            noConnectionDiv.style.visibility = 'visible';
        }

        function packetReceived(packet) {
            try {
                if (packet != null && typeof packet.Type !== 'undefined' && typeof packet.Data !== 'undefined' && packet.Data.length > 0) {
                    if (packet.Type === 'Add') {
                        for (var i = 0; i < packet.Data.length; i++) {
                            processAdd(packet.Data[i]);
                        }
                    }
                    else if (packet.Type === 'Remove') {
                        for (var i = 0; i < packet.Data.length; i++) {
                            processRemove(packet.Data[i]);
                        }
                    }
                    else if (packet.Type === 'Basic') {
                        for (var i = 0; i < packet.Data.length; i++) {
                            processBasic(packet.Data[i]);
                        }
                    }
                    else if (packet.Type === 'TextToSpeech') {
                        var data = packet.Data[0];

                        responsiveVoice.forcedFallbackMode = true;
                        if (responsiveVoice.voiceSupport()) {
                            responsiveVoice.speak(data.Text, data.Voice, { pitch: data.Pitch, rate: data.Rate, volume: data.Volume });
                        }
                    }
                }
            }
            catch (err) { logException(err); }
        }

        function processAdd(data) {
            if (!iframes.has(data.ID)) {
                var itemTemplate = document.querySelector("#iframeContainer");
                const item = itemTemplate.content.cloneNode(true);

                var iframeContainer = item.querySelector(".iframeContainer");
                iframeContainer.srcdoc = data.Content;

                mainOverlayDiv.appendChild(item);

                iframes.set(data.ID, item);
            }
        }

        function processRemove(data) {
            if (!iframes.has(data.ID)) {
                mainOverlayDiv.removeChild(widgetData.get(data.ID));

                widgetData.delete(data.ID);
            }
        }

        function processBasic(data) {
            var duration = parseFloat(data.Duration);
            if (duration != NaN) {

                if (duration <= 0) {
                    duration = 0;
                }

                var itemTemplate = document.querySelector("#iframeContainer");
                const item = itemTemplate.content.cloneNode(true);

                var iframeContainer = item.querySelector(".iframeContainer");
                iframeContainer.onload = function () {
                    setTimeout(function () {
                        mainOverlayDiv.removeChild(item);
                    }, duration);
                }
                iframeContainer.srcdoc = data.Content;

                mainOverlayDiv.appendChild(item);
            }
        }

        function logException(err) {
            console.error(err);
            logToSessionStorage(err);
        }

        openWebsocketConnection();
    </script>
</body>
</html>
